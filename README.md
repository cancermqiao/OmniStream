# OmniStream

OmniStream æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€ä½èµ„æºå ç”¨çš„ B ç«™ç›´æ’­å½•åˆ¶ä¸ä¸Šä¼ å·¥å…·ã€‚

## âœ¨ ç‰¹æ€§

*   **å…¨å¼‚æ­¥æ¶æ„**: åŸºäº Tokio + Axumï¼Œé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚
*   **è‡ªåŠ¨ç›‘å¬**: æ”¯æŒ Bilibili, Douyu, Huya, Twitch ç­‰ä¸»æµå¹³å°ç›´æ’­çŠ¶æ€æ£€æµ‹ã€‚
    *   **API ä¼˜å…ˆ**: ä¼˜å…ˆä½¿ç”¨å®˜æ–¹ API æ£€æµ‹ï¼Œæä½èµ„æºæ¶ˆè€—ã€‚
    *   **FFmpeg å…œåº•**: API å¤±æ•ˆæ—¶è‡ªåŠ¨é™çº§ä¸ºæµæ¢æµ‹ã€‚
*   **æŒä¹…åŒ–å­˜å‚¨**: ä½¿ç”¨ SQLite ä¿å­˜ä»»åŠ¡å†å²å’ŒçŠ¶æ€ï¼Œé‡å¯ä¸ä¸¢å¤±ã€‚
*   **Web UI**: æä¾›å¯è§†åŒ–ç•Œé¢ç®¡ç†ä»»åŠ¡å’ŒæŸ¥çœ‹ç›‘å¬çŠ¶æ€ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

*   **Rust**: éœ€è¦å®‰è£… Rust å·¥å…·é“¾ (Cargo)ã€‚
*   **FFmpeg**: å¿…é¡»å®‰è£…å¹¶åŠ å…¥ç³»ç»Ÿ PATHã€‚
*   **Dioxus CLI** (å¯é€‰ï¼Œç”¨äºå‰ç«¯å¼€å‘): `cargo install dioxus-cli`ã€‚
*   **Biliup CLI**: ç³»ç»Ÿéœ€å®‰è£… Python ç‰ˆæˆ– Rust ç‰ˆ `biliup` å‘½ä»¤è¡Œå·¥å…·ï¼Œå¹¶å®Œæˆç™»å½•ã€‚

### 2. æ•°æ®ç›®å½•ä¸åˆå§‹åŒ–

æ— éœ€é¢„ç½® `server/config.json`ã€‚ä¸‹è½½ä»»åŠ¡ã€ä¸Šä¼ æ¨¡æ¿å’Œå½•åˆ¶è®¾ç½®éƒ½é€šè¿‡ Web UI/API å†™å…¥æ•°æ®åº“ã€‚

é»˜è®¤è¿è¡Œæ—¶æ•°æ®ç›®å½•ï¼š

- `data/omnistream.db`ï¼šSQLite æ•°æ®åº“
- `data/cookies/`ï¼šè´¦å· cookies ä¸ `accounts_meta.json`
- `data/recordings/`ï¼šå½•åˆ¶æ–‡ä»¶ï¼ˆæŒ‰ä»»åŠ¡åå½’æ¡£ï¼‰

### 3. ä¸€é”®å¯åŠ¨

é¡¹ç›®æ ¹ç›®å½•ä¸‹æä¾›äº†å¯åŠ¨è„šæœ¬ï¼š

```bash
chmod +x start.sh
./start.sh
```

è¯¥è„šæœ¬ä¼šï¼š
1.  è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒã€‚
2.  å¯åŠ¨åç«¯ API Server (ç«¯å£ 3000)ã€‚
3.  å¯åŠ¨å‰ç«¯ Web ç•Œé¢ (é€šå¸¸ç«¯å£ 8080)ã€‚
4.  å°†æ—¥å¿—è¾“å‡ºåˆ° `server.log` å’Œ `web.log`ã€‚

åœæ­¢æœåŠ¡ï¼š

```bash
chmod +x stop.sh
./stop.sh
```

### 3.1 ç¼–è¯‘äº§ç‰©å¯åŠ¨ï¼ˆæ¨èçº¿ä¸Šï¼‰

ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶å¯åŠ¨è„šæœ¬ï¼š

```bash
chmod +x start-bin.sh
./start-bin.sh
```

è¯¥è„šæœ¬ä¼šï¼š
1. å¯åŠ¨å‰è‡ªåŠ¨æ‰§è¡Œåç«¯ç¼–è¯‘ï¼š`cargo build --release -p server --bin server`ã€‚
2. è‡ªåŠ¨æ£€æµ‹å‰ç«¯äº§ç‰©ç›®å½•ï¼ˆä¼˜å…ˆ `target/dx/app/release/web/public`ï¼‰ï¼Œè‹¥ç¼ºå¤±ä¼šè‡ªåŠ¨æ‰§è¡Œ `dx build --platform web --release`ã€‚
3. ä½¿ç”¨ `target/release/server` å¯åŠ¨åç«¯ã€‚
4. ä½¿ç”¨ `python3 -m http.server` æ‰˜ç®¡å‰ç«¯é™æ€æ–‡ä»¶ã€‚
5. å°†æ—¥å¿—è¾“å‡ºåˆ° `server.log` å’Œ `web.log`ã€‚
6. å¯ä½¿ç”¨ `./stop.sh` ä¸€é”®åœæ­¢åç«¯ä¸å‰ç«¯ã€‚

### 4. æ‰‹åŠ¨å¯åŠ¨

**åç«¯ Server**:
```bash
cargo run -p server --bin server
```

**å‰ç«¯ App (å¤šç«¯åŒä¸€å¥—ä»£ç )**:
```bash
cd web
dx serve --platform web
```

### 5. å¤šç«¯è¿è¡Œï¼ˆDioxusï¼‰

å‰ç«¯ç›®å½•ç»Ÿä¸€ä¸º `web/`ï¼ˆcrate åä¸º `app`ï¼‰ï¼Œå¯ç›´æ¥åˆ‡æ¢å¹³å°ï¼š

```bash
cd web
dx serve --platform web
dx serve --platform desktop
dx serve --platform ios
dx serve --platform android
```

é»˜è®¤ API åœ°å€è§„åˆ™ï¼š

* `web`: `/api`ï¼ˆåŒåŸŸåå‘ä»£ç†ï¼‰
* `android`: `http://10.0.2.2:3000/api`
* å…¶ä»–æœ¬åœ°å¹³å°ï¼š`http://127.0.0.1:3000/api`

å¯åœ¨æ„å»ºæ—¶è¦†ç›–ï¼š

```bash
BILIUP_API_URL=http://<server-ip>:3000/api dx serve --platform android
```

## ğŸ“˜ å‰ç«¯æµç¨‹æ–‡æ¡£

- `docs/web-flow.md`ï¼šWeb å‰ç«¯æ¨¡å—ã€çŠ¶æ€æµè½¬ã€API æ—¶åºä¸é¡µé¢é€»è¾‘å›¾ã€‚

## ğŸ› ï¸ é¡¹ç›®ç»“æ„

*   `server/`: Rust åç«¯ï¼Œè´Ÿè´£ Monitor, Recorder, Databaseã€‚
*   `web/`: Dioxus å¤šç«¯å‰ç«¯ï¼ˆWeb/Desktop/iOS/Androidï¼‰ï¼Œcrate åä¸º `app`ã€‚
*   `shared/`: å‰åç«¯å…±äº«çš„æ•°æ®ç»“æ„å®šä¹‰ã€‚

## ğŸ“ æ•°æ®åº“

é¡¹ç›®ä½¿ç”¨ SQLiteï¼ˆé»˜è®¤ `data/omnistream.db`ï¼‰å­˜å‚¨æ•°æ®ã€‚æ•°æ®åº“æ–‡ä»¶å’Œè¡¨ç»“æ„ä¼šåœ¨é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºã€‚

å¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–æ•°æ®åº“è·¯å¾„ï¼š

```bash
BILIUP_DB_PATH=/tmp/omnistream.db cargo run -p server
```

## âœ… å¼€å‘è§„èŒƒä¸è´¨é‡é—¨ç¦

é¡¹ç›®ä½¿ç”¨ç»Ÿä¸€çš„ Rust å·¥ç¨‹è§„èŒƒï¼š

* `rust-toolchain.toml`: é”å®šå·¥å…·é“¾ç‰ˆæœ¬ï¼Œé¿å…ç¯å¢ƒæ¼‚ç§»ã€‚
* `LICENSE`: å¼€æºè®¸å¯è¯æ–‡æœ¬ï¼ˆMITï¼‰ã€‚
* `CHANGELOG.md`: å˜æ›´è®°å½•ï¼ŒæŒ‰ç‰ˆæœ¬æŒç»­ç»´æŠ¤ã€‚
* `SECURITY.md`: æ¼æ´æäº¤æµç¨‹ä¸å“åº”ç­–ç•¥ã€‚
* `.github/CODEOWNERS`: ä»£ç å½’å±ä¸è¯„å®¡è´£ä»»è¾¹ç•Œã€‚
* `.editorconfig`: ç»Ÿä¸€æ¢è¡Œã€ç¼©è¿›ä¸ç»“å°¾ç©ºæ ¼è§„åˆ™ã€‚
* `rustfmt.toml`: ç»Ÿä¸€æ ¼å¼åŒ–ç­–ç•¥ã€‚
* `clippy.toml`: ç»Ÿä¸€ Clippy è§„åˆ™åŸºçº¿ã€‚
* `.cargo/config.toml`: ç»Ÿä¸€å¼€å‘å‘½ä»¤åˆ«åã€‚
* `Justfile`: æ ‡å‡†åŒ–æœ¬åœ°å¼€å‘å‘½ä»¤å…¥å£ã€‚
* `deny.toml`: ä¾èµ–å®‰å…¨ä¸è®¸å¯è¯å®¡è®¡è§„åˆ™ã€‚
* `.github/workflows/ci.yml`: CI è‡ªåŠ¨æ‰§è¡Œæ ¼å¼æ£€æŸ¥ã€æµ‹è¯•å’Œ Clippyã€‚

æœ¬åœ°å¼€å‘å»ºè®®åœ¨æäº¤å‰æ‰§è¡Œï¼š

```bash
cargo fmt --all -- --check
cargo test --workspace --all-targets
cargo clippy --workspace --all-targets -- -D warnings
cargo deny check
```

å¦‚æœå®‰è£…äº† `just`ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ï¼š

```bash
just ci
```

## ğŸš¢ ç”Ÿäº§éƒ¨ç½²ï¼ˆæ¨èï¼‰

é¡¹ç›®å·²æä¾›å®¹å™¨åŒ–éƒ¨ç½²éª¨æ¶ï¼ŒåŒ…å«ï¼š

* `Dockerfile.server`ï¼šåç«¯æœåŠ¡é•œåƒï¼ˆå†…ç½® `streamlink`/`ffmpeg`ï¼‰
* `Dockerfile.web`ï¼šå‰ç«¯é™æ€èµ„æºé•œåƒï¼ˆå•æœºé™æ€æœåŠ¡ï¼‰
* `docker-compose.prod.yml`ï¼šç”Ÿäº§ç¼–æ’
* `deploy/deploy.sh`ï¼šå‘å¸ƒè„šæœ¬ï¼ˆDB å¤‡ä»½ã€å¥åº·æ£€æŸ¥ã€å¤±è´¥å›æ»šï¼‰
* `deploy/.env.prod`ï¼šç”Ÿäº§ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆç›´æ¥ç¼–è¾‘ï¼‰

### 1. å‡†å¤‡ç¯å¢ƒå˜é‡

ç›´æ¥ç¼–è¾‘ `deploy/.env.prod`ï¼ŒæŒ‰éœ€ä¿®æ”¹ï¼š

* `REGISTRY`ï¼šé•œåƒä»“åº“åœ°å€ï¼ˆå¦‚ `ghcr.io/your-org`ï¼‰
* `IMAGE_TAG`ï¼šå‘å¸ƒç‰ˆæœ¬ï¼ˆå¦‚ `v0.1.0` æˆ– Git SHAï¼‰
* `API_PORT`ï¼šåç«¯ API ç«¯å£ï¼ˆé»˜è®¤ `3000`ï¼‰
* `WEB_PORT`ï¼šå‰ç«¯é¡µé¢ç«¯å£ï¼ˆé»˜è®¤ `8080`ï¼‰

### 2. æ‰§è¡Œå‘å¸ƒ

```bash
./deploy/deploy.sh
```

è„šæœ¬è¡Œä¸ºï¼š

1. å¤‡ä»½ `data/omnistream.db`
2. æ‹‰å–å¹¶å¯åŠ¨æ–°ç‰ˆæœ¬å®¹å™¨
3. å¥åº·æ£€æŸ¥ `http://127.0.0.1:${API_PORT}/api/tasks`
4. å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªæˆåŠŸç‰ˆæœ¬ tag

### 3. æ•°æ®ç›®å½•

é»˜è®¤æŒ‚è½½ `./data -> /data`ï¼ŒåŒ…å«ï¼š

* `omnistream.db`ï¼ˆSQLiteï¼‰
* `cookies/`ï¼ˆè´¦å·ç™»å½•æ€ï¼‰
* å½•åˆ¶è§†é¢‘æ–‡ä»¶ï¼ˆ`recordings/<ä¸‹è½½ä»»åŠ¡å>/`ï¼‰

### 4. è®¿é—®åœ°å€ï¼ˆå•æœºï¼‰

* å‰ç«¯ï¼š`http://127.0.0.1:${WEB_PORT}`ï¼ˆé»˜è®¤ `http://127.0.0.1:8080`ï¼‰
* åç«¯ï¼š`http://127.0.0.1:${API_PORT}`ï¼ˆé»˜è®¤ `http://127.0.0.1:3000`ï¼‰

å¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–å½•åˆ¶ç›®å½•ï¼š

```bash
BILIUP_RECORDINGS_DIR=/data/recordings
```

## ğŸ§± GitHub Workflow å‘å¸ƒé•œåƒï¼ˆè¯¦ç»†æµç¨‹ï¼‰

å·²æä¾›å·¥ä½œæµï¼š`.github/workflows/release-images.yml`ã€‚

å®ƒä¼šåœ¨ GitHub Actions é‡Œå®Œæˆä»¥ä¸‹äº‹æƒ…ï¼š

1. ä½¿ç”¨ `Dockerfile.server` æ„å»ºåç«¯é•œåƒï¼ˆåŒ…å« Rust ç¼–è¯‘åçš„äºŒè¿›åˆ¶ + ffmpeg + streamlinkï¼‰ã€‚
2. ä½¿ç”¨ `Dockerfile.web` æ„å»ºå‰ç«¯é•œåƒï¼ˆåŒ…å«ç¼–è¯‘åçš„é™æ€æ–‡ä»¶ï¼‰ã€‚
3. æ¨é€åˆ°é•œåƒä»“åº“ï¼ˆé»˜è®¤ GHCRï¼‰ã€‚

è¿™æ„å‘³ç€è…¾è®¯äº‘æœåŠ¡å™¨åªéœ€è¦æ‹‰å–é•œåƒè¿è¡Œï¼Œä¸éœ€è¦å®‰è£… Rust æˆ–å‰ç«¯ç¼–è¯‘å·¥å…·ã€‚

### 1. ä»“åº“å‡†å¤‡

1. æŠŠä»£ç æ¨é€åˆ° GitHubã€‚
2. ç¡®è®¤ä»“åº“å¼€å¯äº† Actions æƒé™ï¼ˆé»˜è®¤å¼€å¯ï¼‰ã€‚
3. å»ºè®®ä»“åº“å¯è§æ€§å…ˆç”¨ privateï¼Œç¨³å®šåå†æŒ‰éœ€è°ƒæ•´ã€‚

### 2. å·¥ä½œæµè§¦å‘æ–¹å¼

æ”¯æŒä¸¤ç§ï¼š

1. æ‰“ tag è‡ªåŠ¨è§¦å‘ï¼š`v*`ï¼Œä¾‹å¦‚ `v0.1.0`ã€‚
2. æ‰‹åŠ¨è§¦å‘ï¼šActions é¡µé¢ç‚¹å‡» `Release Images` -> `Run workflow`ï¼ˆå¯å¡« `image_tag`ï¼‰ã€‚

### 3. ä½¿ç”¨ tag å‘å¸ƒï¼ˆæ¨èï¼‰

åœ¨æœ¬åœ°æ‰§è¡Œï¼š

```bash
git tag v0.1.0
git push origin v0.1.0
```

éšå GitHub Actions ä¼šæ„å»ºå¹¶æ¨é€ï¼š

1. `ghcr.io/<ä½ çš„GitHubç”¨æˆ·åæˆ–ç»„ç»‡>/omnistream-server:v0.1.0`
2. `ghcr.io/<ä½ çš„GitHubç”¨æˆ·åæˆ–ç»„ç»‡>/omnistream-server:latest`
3. `ghcr.io/<ä½ çš„GitHubç”¨æˆ·åæˆ–ç»„ç»‡>/omnistream-web:v0.1.0`
4. `ghcr.io/<ä½ çš„GitHubç”¨æˆ·åæˆ–ç»„ç»‡>/omnistream-web:latest`

### 4. è…¾è®¯äº‘æœåŠ¡å™¨éƒ¨ç½²

1. ä¿®æ”¹ `deploy/.env.prod`ï¼š

```env
REGISTRY=ghcr.io/<ä½ çš„GitHubç”¨æˆ·åæˆ–ç»„ç»‡>
IMAGE_TAG=v0.1.0
API_PORT=3000
WEB_PORT=8080
RUST_LOG=info
```

2. æœåŠ¡å™¨ç™»å½• GHCRï¼ˆå¦‚æœä»“åº“ç§æœ‰ï¼‰ï¼š

```bash
echo <GHCR_TOKEN> | docker login ghcr.io -u <GitHubç”¨æˆ·å> --password-stdin
```

3. æ‰§è¡Œéƒ¨ç½²ï¼š

```bash
./deploy/deploy.sh
```

### 5. å…³äºâ€œæ˜¯å¦åœ¨ Workflow ä¸­ç¼–è¯‘äºŒè¿›åˆ¶â€

æ˜¯çš„ï¼Œåç«¯äºŒè¿›åˆ¶åœ¨ `docker build` çš„ builder é˜¶æ®µå®Œæˆç¼–è¯‘ï¼Œå†å¤åˆ¶åˆ°è¿è¡Œé•œåƒé‡Œã€‚

å› æ­¤æœåŠ¡å™¨ç«¯ä¸éœ€è¦å†æ‰§è¡Œ `cargo build`ã€‚

### 6. å¦‚æœä½ è¦ç”¨è…¾è®¯äº‘ TCRï¼ˆå¯é€‰ï¼‰

ä½ å¯ä»¥æŠŠå·¥ä½œæµé‡Œçš„ç™»å½•æ­¥éª¤æ”¹ä¸º TCR ç™»å½•ï¼ˆç”¨æˆ·å/å¯†ç æ”¾åˆ° GitHub Secretsï¼‰ï¼Œå¹¶æŠŠ `REGISTRY` æ”¹æˆï¼š

`<ä½ çš„TCRåŸŸå>`

å…¶ä½™æµç¨‹ä¸å˜ï¼Œè…¾è®¯äº‘æœºå™¨ç›´æ¥ `docker pull` + `./deploy/deploy.sh` å³å¯ã€‚
